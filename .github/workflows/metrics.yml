name: 🚀 GitHub Metrics Generator

on:
  # Schedule daily updates at 2 AM UTC
  schedule: [{cron: "0 2 * * *"}]
  # Run workflow manually
  workflow_dispatch:
  # Run workflow when pushing to main
  push: {branches: ["main"]}

jobs:
  github-metrics:
    runs-on: [self-hosted, linux, x64]
    environment: 
      name: production
    permissions:
      contents: write
    steps:
      - name: 🧹 Clean Up Old Files
        run: |
          echo "Cleaning up old diagnostic files..."
          # Use environment variables for paths
          RUNNER_DIR="${RUNNER_DIR:-$HOME/github-runner}"
          rm -rf "$RUNNER_DIR/_diag/pages"/*.log 2>/dev/null || true
          rm -rf "$RUNNER_DIR/_work/_temp"/* 2>/dev/null || true
          echo "Cleanup completed"
          
      - name: 🔍 Check Dependencies
        run: |
          echo "Checking required dependencies..."
          for cmd in docker jq curl git; do
            if ! command -v $cmd &> /dev/null; then
              echo "❌ $cmd is not installed"
              exit 1
            else
              echo "✅ $cmd is available"
            fi
          done
          echo "All dependencies are available!"
          
      - name: 📊 Generate GitHub Metrics
        timeout-minutes: 30
        uses: lowlighter/metrics@latest
        with:
          # 🔑 Authentication
          token: ${{ secrets.METRICS_TOKEN }}
          
          # 🎨 Template & Display
          template: classic
          config_display: large
          config_padding: "0, 0"
          config_animations: true
          config_twemoji: true
          config_gemoji: true
          config_octicon: true
          
          # 📁 Base Content - Main Stats Only
          base: header, repositories, metadata
          base_indepth: true
          base_hireable: true
          
          # 📅 Activity & Calendar
          plugin_activity: true
          plugin_activity_limit: 20
          plugin_activity_load: 200
          plugin_activity_days: 365
          plugin_activity_timestamps: true
          plugin_activity_filter: commits,pr,issues,reviews
          
          plugin_calendar: true
          plugin_calendar_limit: 3
          
          # 🧮 Traffic Stats
          plugin_traffic: true
          
          # 🈷️ Languages
          plugin_languages: true
          plugin_languages_indepth: true
          plugin_languages_limit: 8
          plugin_languages_threshold: 1
          plugin_languages_other: true
          plugin_languages_details: true
          plugin_languages_sections: most-used
          
          # 👨‍💻 Lines of Code
          plugin_lines: true
          plugin_lines_sections: repositories,history
          plugin_lines_repositories_limit: 10
          plugin_lines_history_limit: 3
          
          # ⏰ WakaTime Stats (optional - won't fail if token missing)
          plugin_wakatime: true
          plugin_wakatime_token: ${{ secrets.WAKATIME_TOKEN || '' }}
          plugin_wakatime_sections: time,projects,languages,editors,os
          plugin_wakatime_days: 30
          plugin_wakatime_limit: 8
          plugin_wakatime_languages_other: true
          plugin_wakatime_repositories_visibility: all
          
          # ⚙️ Configuration
          config_timezone: America/New_York
          config_order: base,activity,calendar,traffic,languages,lines,wakatime
          optimize: true
          verify: true
          retries: 3
          retries_delay: 5
          
          # 📤 Output
          filename: github-metrics.svg
          output_action: commit
          output_condition: data-changed
          committer_message: "🚀 Auto-generated metrics for run #${{ github.run_number }}"
          
          # 🔧 Debug
          debug: false
          plugins_errors_fatal: false
