name: 🚀 GitHub Metrics Generator

on:
  # Schedule daily updates at 2 AM UTC
  schedule: [{cron: "0 2 * * *"}]
  # Run workflow manually
  workflow_dispatch:
  # Run workflow when pushing to main
  push: {branches: ["main"]}

jobs:
  github-metrics:
    runs-on: [self-hosted, linux, x64]
    environment: 
      name: production
    permissions:
      contents: write
    timeout-minutes: 15
    steps:
      - name: 🧹 Clean Up Old Files
        run: |
          echo "Cleaning up old diagnostic files..."
          rm -rf /home/kaizen/github-runner/_diag/pages/*.log
          rm -rf /home/kaizen/github-runner/_work/_temp/*
          echo "Cleanup completed"
          
      - name: 📦 Install Dependencies
        run: |
          echo "Installing required dependencies..."
          
          # Check if packages are already installed
          if ! command -v docker &> /dev/null; then
            echo "Installing Docker..."
            sudo pacman -S --noconfirm docker
            sudo systemctl start docker
            sudo systemctl enable docker
            sudo usermod -a -G docker $USER
          else
            echo "Docker already installed"
          fi
          
          if ! command -v jq &> /dev/null; then
            echo "Installing jq..."
            sudo pacman -S --noconfirm jq
          else
            echo "jq already installed"
          fi
          
          if ! command -v curl &> /dev/null; then
            echo "Installing curl..."
            sudo pacman -S --noconfirm curl
          else
            echo "curl already installed"
          fi
          
          if ! command -v git &> /dev/null; then
            echo "Installing git..."
            sudo pacman -S --noconfirm git
          else
            echo "git already installed"
          fi
          
          # Test installations
          echo "Docker version: $(docker --version)"
          echo "jq version: $(jq --version)"
          echo "curl version: $(curl --version)"
          echo "git version: $(git --version)"
          
      - name: 🔧 Check Docker Access
        run: |
          echo "Current user: $(whoami)"
          echo "Groups: $(groups)"
          echo "Docker socket: $(ls -la /var/run/docker.sock)"
          docker run --rm hello-world
          
      - name: 📊 Generate GitHub Metrics
        timeout-minutes: 10
        uses: lowlighter/metrics@latest
        with:
          # 🔑 Authentication
          token: ${{ secrets.METRICS_TOKEN }}
          
          # 🎨 Template & Display
          template: classic
          config_display: columns
          config_padding: "0, 8 + 11%"
          config_animations: true
          config_twemoji: true
          config_gemoji: true
          config_octicon: true
          
          # 📁 Base Content - Main Stats
          base: header, activity, community, repositories, metadata
          base_indepth: true
          base_hireable: true
          
          # 📅 Activity & Calendar
          plugin_activity: true
          plugin_activity_limit: 20
          plugin_activity_load: 200
          plugin_activity_days: 365
          plugin_activity_timestamps: true
          plugin_activity_filter: commits,pr,issues,reviews
          
          plugin_calendar: true
          plugin_calendar_limit: 3
          
          # 🈷️ Languages
          plugin_languages: true
          plugin_languages_indepth: true
          plugin_languages_limit: 8
          plugin_languages_threshold: 1
          plugin_languages_other: true
          plugin_languages_details: true
          plugin_languages_sections: most-used,recently-used
          
          # 👨‍💻 Lines of Code
          plugin_lines: true
          plugin_lines_sections: repositories,history
          plugin_lines_repositories_limit: 10
          plugin_lines_history_limit: 3
          
          # 🧮 Traffic Stats
          plugin_traffic: true
          
          # ⏰ WakaTime Stats
          plugin_wakatime: true
          plugin_wakatime_token: ${{ secrets.WAKATIME_TOKEN }}
          plugin_wakatime_sections: time,projects,projects-graphs,languages,languages-graphs,editors,os
          plugin_wakatime_days: 30
          plugin_wakatime_limit: 8
          plugin_wakatime_languages_other: true
          plugin_wakatime_repositories_visibility: all
          
          # ⚙️ Configuration
          config_timezone: America/New_York
          config_order: base,activity,calendar,languages,lines,traffic,wakatime
          optimize: true
          verify: true
          retries: 3
          retries_delay: 5
          
          # 📤 Output
          filename: github-metrics.svg
          output_action: commit
          output_condition: data-changed
          committer_message: "🚀 Auto-generated metrics for run #${{ github.run_number }}"
          
          # 🔧 Debug
          debug: true
          plugins_errors_fatal: false